<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face ID Davomat Tizimi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 40px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type=file] {
            display: none;
        }

        .file-upload-label {
            display: block;
            padding: 12px;
            background: #f8f9fa;
            border: 2px dashed #4facfe;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-label:hover {
            background: #e7f3ff;
        }

        .preview-container {
            margin-top: 15px;
            text-align: center;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
        }

        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .webcam-container {
            text-align: center;
            margin: 20px 0;
        }

        .webcam-video {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .capture-btn {
            margin-top: 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .capture-btn:hover {
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-bottom: 1px solid #f0f0f0;
            }
            
            .tab.active {
                border-bottom: 1px solid #4facfe;
                background: #f0f9ff;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≠ Simple Face ID Davomat Tizimi</h1>
            <p>OpenCV asosida yuz tanish texnologiyasi bilan davomat nazorati</p>
            <small style="opacity: 0.8;">üí° dlib muammosi uchun alternative yechim</small>
        </div>
        
        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('register')">Ro'yxatga olish</button>
                <button class="tab" onclick="showTab('attendance')">Davomat belgilash</button>
                <button class="tab" onclick="showTab('statistics')">Statistika</button>
            </div>
            
            <!-- Ro'yxatga olish tab -->
            <div id="register" class="tab-content active">
                <h3>üìù Xodimning yuzini ro'yxatga olish</h3>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="employeeSelect">Xodimni tanlang:</label>
                        <select id="employeeSelect" required>
                            <option value="">Xodimni tanlang...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Rasm yuklash:</label>
                        <div class="file-upload">
                            <input type="file" id="registerImageInput" accept="image/*" required>
                            <label for="registerImageInput" class="file-upload-label">
                                üì∑ Rasm tanlang yoki bu yerga tashlang
                            </label>
                        </div>
                        <div id="registerPreview" class="preview-container"></div>
                    </div>
                    
                    <button type="submit" class="btn">Ro'yxatga olish</button>
                </form>
                
                <div class="webcam-container">
                    <h4>üìπ Yoki veb-kamera orqali</h4>
                    <div id="webcamStatus" style="margin: 10px 0; padding: 10px; border-radius: 5px; display: none;">
                        üìä Kamera holati
                    </div>
                    <video id="webcamVideo" class="webcam-video" autoplay muted style="display: none;"></video>
                    <canvas id="webcamCanvas" style="display: none;"></canvas>
                    <br>
                    <button id="startWebcam" class="btn">üì∑ Kamerani yoqish</button>
                    <button id="captureBtn" class="btn capture-btn" style="display: none;">üì∏ Rasmga olish</button>
                    <button id="stopWebcam" class="btn btn-danger" style="display: none;">‚èπÔ∏è Kamerani yopish</button>
                    
                    <div id="webcamTips" style="margin-top: 15px; font-size: 14px; color: #666;">
                        <strong>üí° Maslahatlar:</strong><br>
                        ‚Ä¢ Yuzingizni to'g'ridan-to'g'ri kameraga qarating<br>
                        ‚Ä¢ Yetarli yorug'lik ta'minlang<br>
                        ‚Ä¢ 1-2 metr masofada turing<br>
                        ‚Ä¢ Ko'zoynak yoki niqob taqmang
                    </div>
                </div>
                
                <div id="registerResult"></div>
            </div>
            
            <!-- Davomat belgilash tab -->
            <div id="attendance" class="tab-content">
                <h3>‚úÖ Yuz tanish orqali davomat belgilash</h3>
                <form id="attendanceForm">
                    <div class="form-group">
                        <label for="checkType">Harakat turi:</label>
                        <select id="checkType" required>
                            <option value="IN">Kelish</option>
                            <option value="OUT">Ketish</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Rasm yuklash:</label>
                        <div class="file-upload">
                            <input type="file" id="attendanceImageInput" accept="image/*" required>
                            <label for="attendanceImageInput" class="file-upload-label">
                                üì∑ Rasm tanlang yoki bu yerga tashlang
                            </label>
                        </div>
                        <div id="attendancePreview" class="preview-container"></div>
                    </div>
                    
                    <button type="submit" class="btn">Davomat belgilash</button>
                </form>
                
                <div class="webcam-container">
                    <h4>üìπ Yoki veb-kamera orqali</h4>
                    <div id="webcamStatus2" style="margin: 10px 0; padding: 10px; border-radius: 5px; display: none;">
                        üìä Kamera holati
                    </div>
                    <video id="webcamVideo2" class="webcam-video" autoplay muted style="display: none;"></video>
                    <canvas id="webcamCanvas2" style="display: none;"></canvas>
                    <br>
                    <button id="startWebcam2" class="btn">üì∑ Kamerani yoqish</button>
                    <button id="captureBtn2" class="btn capture-btn" style="display: none;">üì∏ Rasmga olish</button>
                    <button id="stopWebcam2" class="btn btn-danger" style="display: none;">‚èπÔ∏è Kamerani yopish</button>
                    
                    <div id="webcamTips2" style="margin-top: 15px; font-size: 14px; color: #666;">
                        <strong>üí° Davomat uchun maslahatlar:</strong><br>
                        ‚Ä¢ Yuzingizni aniq ko'rsating<br>
                        ‚Ä¢ Bir xil sharoitda rasm oling<br>
                        ‚Ä¢ Kamerani silkitmang<br>
                        ‚Ä¢ Tabassumli bo'ling üòä
                    </div>
                </div>
                
                <div id="attendanceResult"></div>
            </div>
            
            <!-- Statistika tab -->
            <div id="statistics" class="tab-content">
                <h3>üìä Face ID tizimi statistikalari</h3>
                <button id="loadStats" class="btn">Statistikani yuklash</button>
                <div id="statsResult"></div>
            </div>
        </div>
    </div>

    <script>
        // Base API URL - dinamik aniqlash
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:8000' 
            : `http://${window.location.hostname}:8000`;
            
        console.log('üîó API Base URL:', API_BASE);
        
        // Tab functions
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }
        
        // Load employees on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await loadEmployees();
        });
        
        // Load employees function
        async function loadEmployees() {
            try {
                const response = await fetch(`${API_BASE}/employees`);
                const employees = await response.json();
                
                const select = document.getElementById('employeeSelect');
                select.innerHTML = '<option value="">Xodimni tanlang...</option>';
                
                employees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.full_name} - ${emp.position}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Xodimlarni yuklashda xatolik:', error);
            }
        }
        
        // Image preview functions
        function setupImagePreview(inputId, previewId) {
            document.getElementById(inputId).addEventListener('change', function(e) {
                const file = e.target.files[0];
                const preview = document.getElementById(previewId);
                
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="Preview">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = '';
                }
            });
        }
        
        setupImagePreview('registerImageInput', 'registerPreview');
        setupImagePreview('attendanceImageInput', 'attendancePreview');
        
        // Register form submission
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeId = document.getElementById('employeeSelect').value;
            const imageFile = document.getElementById('registerImageInput').files[0];
            
            if (!employeeId || !imageFile) {
                showResult('registerResult', 'Iltimos, xodim va rasmni tanlang!', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('employee_id', employeeId);
            formData.append('image', imageFile);
            
            try {
                const response = await fetch(`${API_BASE}/face-id/register`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showResult('registerResult', result.message, 'success');
                    document.getElementById('registerForm').reset();
                    document.getElementById('registerPreview').innerHTML = '';
                } else {
                    showResult('registerResult', result.message, 'error');
                }
            } catch (error) {
                showResult('registerResult', 'Serverga ulanishda xatolik!', 'error');
            }
        });
        
        // Attendance form submission
        document.getElementById('attendanceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const checkType = document.getElementById('checkType').value;
            const imageFile = document.getElementById('attendanceImageInput').files[0];
            
            if (!imageFile) {
                showResult('attendanceResult', 'Iltimos, rasm tanlang!', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('check_type', checkType);
            formData.append('image', imageFile);
            
            try {
                const response = await fetch(`${API_BASE}/face-id/recognize`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showResult('attendanceResult', `‚úÖ ${result.message}<br>Ishonch: ${result.recognition.confidence}`, 'success');
                    document.getElementById('attendanceForm').reset();
                    document.getElementById('attendancePreview').innerHTML = '';
                } else {
                    showResult('attendanceResult', result.message, 'error');
                }
            } catch (error) {
                showResult('attendanceResult', 'Serverga ulanishda xatolik!', 'error');
            }
        });
        
        // Load statistics
        document.getElementById('loadStats').addEventListener('click', async function() {
            try {
                const response = await fetch(`${API_BASE}/face-id/statistics`);
                const data = await response.json();
                
                const stats = data.face_id_statistics;
                
                let html = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${stats.total_employees}</div>
                            <div class="stat-label">Ro'yxatga olingan xodimlar</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.total_faces}</div>
                            <div class="stat-label">Jami yuzlar</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.average_faces_per_employee.toFixed(1)}</div>
                            <div class="stat-label">O'rtacha yuz/xodim</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${(stats.tolerance * 100).toFixed(0)}%</div>
                            <div class="stat-label">Tanish sezgirligi</div>
                        </div>
                    </div>
                `;
                
                if (stats.employee_details.length > 0) {
                    html += '<h4 style="margin-top: 30px;">Xodimlar tafsiloti:</h4>';
                    html += '<div style="margin-top: 15px;">';
                    
                    stats.employee_details.forEach(emp => {
                        html += `
                            <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px;">
                                <strong>${emp.employee_name}</strong> (ID: ${emp.employee_id})<br>
                                <small>Ro'yxatga olingan yuzlar: ${emp.face_count}</small>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                document.getElementById('statsResult').innerHTML = html;
            } catch (error) {
                showResult('statsResult', 'Statistikani yuklashda xatolik!', 'error');
            }
        });
        
        // Show result function
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = message;
            element.style.display = 'block';
            
            // Auto hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }
        
        // Webcam functions
        function setupWebcam(videoId, canvasId, startBtnId, captureBtnId, stopBtnId, previewId, statusId) {
            let stream = null;
            
            function showStatus(message, type = 'info') {
                const statusElement = document.getElementById(statusId);
                if (statusElement) {
                    statusElement.style.display = 'block';
                    statusElement.style.background = type === 'error' ? '#f8d7da' : '#d1ecf1';
                    statusElement.style.color = type === 'error' ? '#721c24' : '#0c5460';
                    statusElement.innerHTML = `üìä ${message}`;
                }
            }
            
            document.getElementById(startBtnId).addEventListener('click', async function() {
                try {
                    showStatus('Kameraga ruxsat so\'ralmoqda...', 'info');
                    
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user' 
                        } 
                    });
                    
                    const video = document.getElementById(videoId);
                    video.srcObject = stream;
                    video.style.display = 'block';
                    
                    showStatus('‚úÖ Kamera muvaffaqiyatli yoqildi!', 'success');
                    
                    document.getElementById(startBtnId).style.display = 'none';
                    document.getElementById(captureBtnId).style.display = 'inline-block';
                    document.getElementById(stopBtnId).style.display = 'inline-block';
                    
                    // Video yuklangandan keyin statusni yashirish
                    video.addEventListener('loadedmetadata', () => {
                        setTimeout(() => {
                            if (statusElement) statusElement.style.display = 'none';
                        }, 2000);
                    });
                    
                } catch (error) {
                    console.error('Kamera xatosi:', error);
                    showStatus('‚ùå Kameraga ruxsat berilmadi yoki kamera mavjud emas!', 'error');
                }
            });
            
            document.getElementById(captureBtnId).addEventListener('click', function() {
                const video = document.getElementById(videoId);
                const canvas = document.getElementById(canvasId);
                const ctx = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                showStatus('üì∏ Rasm olindi!', 'success');
                
                canvas.toBlob(function(blob) {
                    // Create a file from blob
                    const file = new File([blob], 'webcam-capture.jpg', { type: 'image/jpeg' });
                    
                    // Update the file input
                    const inputId = previewId === 'registerPreview' ? 'registerImageInput' : 'attendanceImageInput';
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    document.getElementById(inputId).files = dt.files;
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById(previewId).innerHTML = `<img src="${e.target.result}" class="preview-image" alt="Captured">`;
                    };
                    reader.readAsDataURL(file);
                    
                    showStatus('‚úÖ Rasm tayyor! Endi yuborish tugmasini bosing.', 'success');
                });
            });
            
            document.getElementById(stopBtnId).addEventListener('click', function() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    document.getElementById(videoId).style.display = 'none';
                    showStatus('‚èπÔ∏è Kamera yopildi', 'info');
                }
                
                document.getElementById(startBtnId).style.display = 'inline-block';
                document.getElementById(captureBtnId).style.display = 'none';
                document.getElementById(stopBtnId).style.display = 'none';
                
                setTimeout(() => {
                    const statusElement = document.getElementById(statusId);
                    if (statusElement) statusElement.style.display = 'none';
                }, 2000);
            });
        }
        
        // Setup webcams
        setupWebcam('webcamVideo', 'webcamCanvas', 'startWebcam', 'captureBtn', 'stopWebcam', 'registerPreview', 'webcamStatus');
        setupWebcam('webcamVideo2', 'webcamCanvas2', 'startWebcam2', 'captureBtn2', 'stopWebcam2', 'attendancePreview', 'webcamStatus2');
    </script>
</body>
</html>
